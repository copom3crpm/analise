<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Homicídios 3ª RISP - 2025</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #323130;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-container {
            display: flex;
            width: 100%;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
            overflow-y: auto;
        }

        .sidebar h2 {
            padding: 0 20px 30px 20px;
            text-align: center;
            font-size: 1.4rem;
            border-bottom: 1px solid #4a627a;
        }

        .sidebar ul {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            border-left: 3px solid transparent;
        }

        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background: #34495e;
            color: white;
            border-left-color: #3498db;
        }

        .sidebar ul li a i {
            margin-right: 15px;
        }
        
        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .header img {
            height: 70px;
        }

        .header-title {
            text-align: center;
            color: #2c3e50;
        }

        .header-title h1 {
            font-size: 1.6rem;
            font-weight: 600;
            margin: 0;
        }
        
        .header-title h2 {
            font-size: 1.1rem;
            font-weight: 400;
            margin: 5px 0;
        }

        .header-title p {
            font-size: 1rem;
            color: #7f8c8d;
            margin: 0;
        }

        .filter-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .filter-container h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            color: #34495e;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            transition: border-color 0.2s;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .filter-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .filter-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        #reset-filters {
            background-color: #e74c3c;
            color: white;
        }

        #reset-filters:hover {
            background-color: #c0392b;
        }

        #export-csv, #export-json {
            background-color: #27ae60;
            color: white;
        }

        #export-csv:hover, #export-json:hover {
            background-color: #229954;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }

        .kpi-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .kpi-card .label {
            font-size: 1rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 15px;
        }

        .chart-title h4 {
            font-size: 1.1rem;
            color: #34495e;
        }

        .chart-title .total {
            font-size: 1.5rem;
            font-weight: bold;
            color: #bdc3c7;
        }

        .chart-container {
            height: 350px;
            position: relative;
        }
        
        .chart-container-large {
             height: 450px;
        }

        /* Styles for Dias Sem Homicídio Page */
        .dias-sem-homicidio-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            align-items: start;
        }
        .cidade-selector-card, .resultado-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .cidade-selector-card h3 {
            margin-bottom: 15px;
            color: #34495e;
        }
        .cidade-selector-card select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .resultado-card h2 {
            font-size: 2.2rem;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .dias-container {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            transition: background-color 0.5s ease;
        }
        .dias-valor {
            display: block;
            font-size: 5rem;
            font-weight: bold;
        }
        .dias-label {
            font-size: 1.2rem;
        }
        .status-green { background-color: #2ecc71; color: white; }
        .status-yellow { background-color: #f1c40f; color: #333; }
        .status-red { background-color: #e74c3c; color: white; }
        .resultado-card p {
            font-size: 1.1rem;
            color: #7f8c8d;
            text-align: center;
            margin-top: 15px;
        }
        
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
            font-size: 1.2rem;
            color: #2c3e50;
        }

    </style>
</head>
<body>
    <div id="loading-overlay">
        <p>Carregando dados da planilha...</p>
    </div>
    <div class="dashboard-container">
        <nav class="sidebar">
            <h2>Homicídios 3ª RISP</h2>
            <ul id="nav-links">
                <li><a href="#visao-geral" class="nav-link active"><i class="ph-bold ph-chart-bar"></i> Visão Geral</a></li>
                <li><a href="#perfil-ocorrencia" class="nav-link"><i class="ph-bold ph-file-text"></i> Perfil da Ocorrência</a></li>
                <li><a href="#vitimas-autoria" class="nav-link"><i class="ph-bold ph-users"></i> Vítimas e Autoria</a></li>
                <li><a href="#resolucao-situacao" class="nav-link"><i class="ph-bold ph-check-square"></i> Resolução e Situação</a></li>
                <li><a href="#dias-sem-homicidio" class="nav-link"><i class="ph-bold ph-calendar-check"></i> Dias Sem Homicídio</a></li>
            </ul>
        </nav>

        <main class="main-content">
            
            <header class="header">
                <img src="data:image/jpeg;base64,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" alt="Logo COPOM">
                <div class="header-title">
                    <h1>3° Comando Regional da Polícia Militar</h1>
                    <h2>Centro de Atendimento Policial Militar - COPOM</h2>
                    <p>Análise Criminal - Controle de Homicídios</p>
                </div>
                <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAYGBgYHBgcICAcKCwoLCg8ODAwODxYQERAREBYiFRkVFRkVIh4kHhweJB42KiYmKjY+NDI0PkxERExfWl98fKcBBgYGBgcGBwgIBwoLCgsKDw4MDA4PFhAREBEQFiIVGRUVGRUiHiQeHB4kHjYqJCYqNj40MjQ+TERETF9aX3x8p//CABEIAMgAyAMBIgACEQEDEQH/xAAbAAEBAAMBAQEAAAAAAAAAAAAAAwQFBgIBB//aAAgBAQAAAAD7gAAAAAAAAAAAAAAAAAAAAAAAAABGq8N9WwAAcNX5npkAAcXXOX6UABxds5lpQAHF2zmWlAAcXbOZaUABxdc5fpQAHDU+Z6YABGq8N9WwAAAAAAAAAAAAAAAAAAAAAAAAB//xAAZAQEBAQEBAQAAAAAAAAAAAAAAAQIDBAX/2gAIAQIQAAAAA+403OADLWWWgDLWWWgDLWWWgDLWWWgDLWWWgDLWWWgDLWWWgDLWWWgD7jTc4AP/EABgBAQEBAQEAAAAAAAAAAAAAAAABAgME/9oACAECEAAAAA+403OADLWWWgDLWWWgDLWWWgDLWWWgDLWWWgDLWWWgDLWWWgDLWWWgD7jTc4AP/8QANRAAAQMCAwUGBgICAwAAAAAAAQACAwQRITESQVEQEyJhcYEUMlKRIjNAUoKhsWKCorLB0f/aAAgBAQABPwD/AOQ49c3+Q/zY9c3+Q/zY9c3+Q/zY9c3+Q/zY9c3+Q/zY9c3+Q/zY9c3+Q/zY9c3+Q/zY9c3+Q/wA2PXN/kP8ANj1z/wCQ/wA2PXN/kP8ANuFxcST1/wAzHrm/yH+bHrm/yH+bHrm/yH+bHrm/yH+bHrm/yH+bHrm/yH+bHrm/yH+bHrm/yH+bHrm/yH+bHrm/yH+bHrm/yH+bHrm/wAh/m3C5xcSet/wDmMfXN/kP82PXN/kP82PXN/kP82PXN/kP82PXN/kP82PXN/kP82PXN/kP82PXN/kP82PXN/kP82PXN/kP82PXN/wCQ/wA2PXN/kP8ANuFzi5x6/wDkR7rB/f8A0o91g/v/AKUe6wf3/wBKPdYP7/6Ue6wf3/0o91g/v/pR7rB/f/Sj3WD+/wDpR7rB/f8A0o91g/v/AKUe6wf3/wBKPdYP7/6UEtcHN6Ee9w/3n9KPdYP7/wClHusH9/8ASj3WD+/+lHusH9/9KPcx/wB5/Sj3WD+/+lHusH9/9KPdYP7/AOlHusH9/wDSoLWuDhzB//EABwRAAIDAQEBAQAAAAAAAAAAAAABAhETEiExQf/aAAgBAQABPxA9b/bF48iO2S82z6L+2Lx5Edsl5tn0X9sXjyI7ZLyvX/q/tjwY8CO2z8y9e/7Y8GPIjts/MvXv+2PBjyI7bLz83r/2PAjwI7bLyv/U9b/bF48iO2S82z6L+2Lx5Edsl5tn0X9sXjyI7ZLyvX/q/tjwY8CO2z8y9e/7Y8GPIjts/MvXv+2PBjyI7bLz83r/2PAjwI7bLyv8A1Pr8UvF4v8Xil+C/xS8X+LxS/Bf4peL/ABeKX4L/ABS8X+LxS/Bf4peL/F4pfgv8UvF/i8UvwX+KXi/xeKX4L/FLxf4vFL8F/il4v8Xil+C/xS8X+LxS/Bf/xAAmEAEAAgIBBAEFAQEBAAAAAAABABEhMUFRYXEQgSCRoTCxwfDB4f/aAAgBAQABPyH7iYf+R//Z" alt="Logo 3ª CRPM">
            </header>

            <div class="filter-container">
                <h3>Filtros Interativos</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-municipio">Município</label>
                        <select id="filter-municipio"></select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-unidade">Unidade</label>
                        <select id="filter-unidade"></select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-instrumento">Instrumento</label>
                        <select id="filter-instrumento"></select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-ambiente">Ambiente</label>
                        <select id="filter-ambiente"></select>
                    </div>
                    <div class="filter-group">
                         <label for="filter-ano">Ano</label>
                        <select id="filter-ano"></select>
                    </div>
                </div>
                 <div class="filter-buttons">
                    <button id="reset-filters">Limpar Filtros</button>
                    <button id="export-csv">Exportar CSV</button>
                    <button id="export-json">Exportar JSON</button>
                </div>
            </div>

            <div class="page-content">
                <!-- Página: Visão Geral -->
                <div id="visao-geral" class="page active">
                    <div class="kpi-container">
                        <div class="kpi-card">
                            <div id="kpi-total" class="value">0</div>
                            <div class="label">Total de Homicídios</div>
                        </div>
                        <div class="kpi-card">
                            <div id="kpi-resolvidos" class="value">0</div>
                            <div class="label">Casos Resolvidos</div>
                        </div>
                        <div class="kpi-card">
                            <div id="kpi-pendentes" class="value">0</div>
                            <div class="label">Casos Pendentes</div>
                        </div>
                        <div class="kpi-card">
                            <div id="kpi-taxa-resolucao" class="value">0%</div>
                            <div class="label">% de Resolução</div>
                        </div>
                    </div>
                    <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-title">
                                <h4>Homicídios por Mês</h4>
                                <span id="total-homicidios-mes" class="total"></span>
                            </div>
                            <div class="chart-container">
                                <canvas id="chart-homicidios-mes"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                             <div class="chart-title">
                                <h4>Ranking de Municípios</h4>
                                <span id="total-ranking-municipios" class="total"></span>
                            </div>
                            <div class="chart-container">
                                 <canvas id="chart-ranking-municipios"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Página: Perfil da Ocorrência -->
                <div id="perfil-ocorrencia" class="page">
                     <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-title"><h4>Distribuição por Instrumento</h4></div>
                            <div class="chart-container">
                                <canvas id="chart-instrumento"></canvas>
                            </div>
                        </div>
                         <div class="chart-card">
                            <div class="chart-title"><h4>Distribuição por Ambiente</h4></div>
                            <div class="chart-container">
                                <canvas id="chart-ambiente"></canvas>
                            </div>
                        </div>
                         <div class="chart-card full-width">
                            <div class="chart-title">
                                <h4>Motivação da Ocorrência</h4>
                                <span id="total-motivacao" class="total"></span>
                            </div>
                            <div class="chart-container chart-container-large">
                                <canvas id="chart-motivacao"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Página: Vítimas e Autoria -->
                <div id="vitimas-autoria" class="page">
                    <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-title"><h4>Vítimas por Gênero</h4></div>
                            <div class="chart-container">
                                <canvas id="chart-genero"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title"><h4>Situação da Autoria</h4></div>
                            <div class="chart-container">
                                <canvas id="chart-autoria"></canvas>
                            </div>
                        </div>
                         <div class="chart-card full-width">
                            <div class="chart-title">
                                <h4>Relação Motivação vs Gênero da Vítima</h4>
                                <span id="total-motivacao-genero" class="total"></span>
                            </div>
                            <div class="chart-container chart-container-large">
                               <canvas id="chart-motivacao-genero"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Página: Resolução e Situação Atual -->
                <div id="resolucao-situacao" class="page">
                    <div class="chart-grid">
                         <div class="chart-card">
                            <div class="chart-title"><h4>Resolução dos Casos</h4></div>
                            <div class="chart-container">
                                <canvas id="chart-resolucao"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title"><h4>Resposta Policial</h4></div>
                            <div class="chart-container">
                                <canvas id="chart-resposta"></canvas>
                            </div>
                        </div>
                        <div class="chart-card full-width">
                            <div class="chart-title">
                               <h4>Comparativo de Resolução por Unidade</h4>
                               <span id="total-resolucao-unidade" class="total"></span>
                            </div>
                             <div class="chart-container chart-container-large">
                               <canvas id="chart-resolucao-unidade"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Página: Dias Sem Homicídio -->
                <div id="dias-sem-homicidio" class="page">
                    <div class="dias-sem-homicidio-container">
                        <div class="cidade-selector-card">
                            <h3>Selecione uma Cidade</h3>
                            <select id="cidadeSelect">
                                <option value="">-- Selecione --</option>
                            </select>
                        </div>
                        <div id="resultado-dias" class="resultado-card" style="display: none;">
                            <h2 id="cidadeNome"></h2>
                            <div class="dias-container">
                                <span id="diasSemHomicidio" class="dias-valor"></span>
                                <span class="dias-label">dias sem homicídio</span>
                            </div>
                            <p id="dataUltimoHomicidio"></p>
                            <p id="mensagemSemRegistro" style="display: none;"></p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
    <script>
        // URL da planilha do Google Sheets. O dashboard buscará os dados daqui.
        const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaVwtuyh-PxPwjA6yZ5twRF4xamo5UrlEmh5zo4BldYtNZfpJ9u-4xfg7f11uEbA/pub?output=csv';

        // Global variables
        let fullData = [];
        let diasSemHomicidioData = {};
        const chartInstances = {};

        // Chart.js global settings
        Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', 'Arial', sans-serif";
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.responsive = true;
        Chart.defaults.maintainAspectRatio = false;

        document.addEventListener('DOMContentLoaded', () => {
            loadAndInitializeDashboard();
        });

        function showLoading(show, message = 'Carregando...') {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.querySelector('p').textContent = message;
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }

        function loadAndInitializeDashboard() {
            showLoading(true, 'Buscando dados da planilha...');
            // Adiciona um parâmetro único à URL para evitar problemas de cache
            const urlWithCacheBuster = `${DATA_URL}&timestamp=${new Date().getTime()}`;

            Papa.parse(urlWithCacheBuster, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    showLoading(true, 'Processando dados...');
                    try {
                        fullData = processData(validateData(results.data));
                        diasSemHomicidioData = calcularDiasSemHomicidio(fullData);
                        
                        populateFilters();
                        populateCidadeSelect();
                        setupEventListeners();
                        updateDashboard();
                    } catch (error) {
                         console.error('Erro ao processar os dados:', error);
                         showLoading(true, 'Erro ao processar os dados. Verifique o console.');
                    } finally {
                        showLoading(false);
                    }
                },
                error: function(error) {
                    console.error('Erro ao buscar ou parsear o CSV:', error);
                    showLoading(true, 'Falha ao carregar os dados da planilha. Verifique a conexão e o link.');
                }
            });
        }
        
        function processData(data) {
            return data.map(row => {
                // As chaves (headers) vêm do arquivo CSV
                const dateParts = row['Data do fato'] ? row['Data do fato'].split('/') : null;
                const date = dateParts && dateParts.length === 3 ? new Date(Date.UTC(dateParts[2], dateParts[1] - 1, dateParts[0])) : null;
                
                let resolucaoNormalizada = 'Não';
                const resolucao = (row['Resolução'] || '').toLowerCase();
                if (resolucao.includes('preso') || resolucao.includes('cumpriu')) {
                    resolucaoNormalizada = 'Sim';
                }

                return {
                    ...row,
                    'Data do fato': date,
                    'Ano': date ? date.getUTCFullYear() : null,
                    'Mês': date ? date.getUTCMonth() : null, // 0-11
                    'ResoluçãoNormalizada': resolucaoNormalizada
                };
            }).filter(row => row['Data do fato']);
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.querySelector(link.getAttribute('href')).classList.add('active');

                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });

            document.querySelectorAll('.filter-group select').forEach(select => {
                select.addEventListener('change', updateDashboard);
            });
            
            document.getElementById('reset-filters').addEventListener('click', () => {
                document.querySelectorAll('.filter-group select').forEach(select => {
                    select.value = 'todos';
                });
                updateDashboard();
            });

            document.getElementById('export-csv').addEventListener('click', () => exportData('csv'));
            document.getElementById('export-json').addEventListener('click', () => exportData('json'));
            
            document.getElementById('cidadeSelect').addEventListener('change', (e) => {
                displayDiasSemHomicidio(e.target.value);
            });
        }

        function populateFilters() {
            const filterKeys = {
                'filter-municipio': 'Município', 'filter-unidade': 'Unidade',
                'filter-instrumento': 'Instrumento', 'filter-ambiente': 'Ambiente', 'filter-ano': 'Ano'
            };

            for (const [selectId, dataKey] of Object.entries(filterKeys)) {
                const select = document.getElementById(selectId);
                const options = ['Todos', ...new Set(fullData.map(item => item[dataKey]).filter(Boolean))].sort((a, b) => (a === 'Todos' ? -1 : b === 'Todos' ? 1 : String(a).localeCompare(String(b))));
                select.innerHTML = options.map(opt => `<option value="${String(opt).toLowerCase()}">${opt}</option>`).join('');
            }
        }
        
        function getFilteredData() {
             const filters = {
                municipio: document.getElementById('filter-municipio').value,
                unidade: document.getElementById('filter-unidade').value,
                instrumento: document.getElementById('filter-instrumento').value,
                ambiente: document.getElementById('filter-ambiente').value,
                ano: document.getElementById('filter-ano').value
            };

            return fullData.filter(d => 
                (filters.municipio === 'todos' || (d['Município'] || '').toLowerCase() === filters.municipio) &&
                (filters.unidade === 'todos' || (d['Unidade'] || '').toLowerCase() === filters.unidade) &&
                (filters.instrumento === 'todos' || (d['Instrumento'] || '').toLowerCase() === filters.instrumento) &&
                (filters.ambiente === 'todos' || (d['Ambiente'] || '').toLowerCase() === filters.ambiente) &&
                (filters.ano === 'todos' || String(d['Ano']) === filters.ano)
            );
        }

        function updateDashboard() {
            const filteredData = getFilteredData();
            updateKPIs(filteredData);
            updateCharts(filteredData);
        }

        function updateKPIs(data) {
            const total = data.length;
            const resolvidos = data.filter(d => d.ResoluçãoNormalizada === 'Sim').length;
            const taxaResolucao = total > 0 ? ((resolvidos / total) * 100).toFixed(1) + '%' : '0%';

            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-resolvidos').textContent = resolvidos;
            document.getElementById('kpi-pendentes').textContent = total - resolvidos;
            document.getElementById('kpi-taxa-resolucao').textContent = taxaResolucao;
        }
        
        function updateCharts(data) {
            const total = data.length;
            document.querySelectorAll('.total').forEach(el => el.textContent = total);
            
            renderTimeChart('chart-homicidios-mes', data);
            renderRankingChart('chart-ranking-municipios', data, 'Município');
            renderDonutChart('chart-instrumento', data, 'Instrumento');
            renderDonutChart('chart-ambiente', data, 'Ambiente');
            renderBarChart('chart-motivacao', data, 'Motivação', false);
            renderDonutChart('chart-genero', data, 'Gênero');
            renderPieChart('chart-autoria', data, 'Autoria');
            renderStackedBarChart('chart-motivacao-genero', data, 'Motivação', 'Gênero');
            renderPieChart('chart-resolucao', data, 'ResoluçãoNormalizada', true);
            renderDonutChart('chart-resposta', data, 'Resposta');
            renderResolutionComparisonChart('chart-resolucao-unidade', data, 'Unidade');
        }

        // --- Novas Funções: Dias Sem Homicídio ---
        function calcularDiasSemHomicidio(dados) {
            const hoje = new Date();
            hoje.setUTCHours(0, 0, 0, 0);
            const resultado = {};
            const cidades = [...new Set(dados.map(item => item['Município']))];

            cidades.forEach(cidade => {
                const homicidiosCidade = dados
                    .filter(item => item['Município'] === cidade && item['Data do fato'])
                    .map(item => item['Data do fato'])
                    .sort((a, b) => b - a);

                if (homicidiosCidade.length === 0) {
                    resultado[cidade] = null;
                } else {
                    const ultimo = homicidiosCidade[0];
                    const diff = Math.floor((hoje - ultimo) / (1000 * 60 * 60 * 24));
                    resultado[cidade] = { dias: diff, ultimoHomicidio: ultimo.toLocaleDateString('pt-BR', {timeZone: 'UTC'}) };
                }
            });
            return resultado;
        }

        function populateCidadeSelect() {
            const select = document.getElementById('cidadeSelect');
            const cidades = Object.keys(diasSemHomicidioData).sort();
            select.innerHTML = '<option value="">-- Selecione uma cidade --</option>' + 
                               cidades.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function displayDiasSemHomicidio(cidade) {
            const resultadoContainer = document.getElementById('resultado-dias');
            if (!cidade) {
                resultadoContainer.style.display = 'none';
                return;
            }

            resultadoContainer.style.display = 'block';
            const data = diasSemHomicidioData[cidade];
            
            const cidadeNomeEl = document.getElementById('cidadeNome');
            const diasEl = document.getElementById('diasSemHomicidio');
            const ultimoEl = document.getElementById('dataUltimoHomicidio');
            const msgEl = document.getElementById('mensagemSemRegistro');
            const diasContainer = document.querySelector('.dias-container');
            const diasLabelEl = diasContainer.querySelector('.dias-label');

            cidadeNomeEl.textContent = cidade;

            if (data === null) {
                diasContainer.style.display = 'none';
                ultimoEl.style.display = 'none';
                msgEl.style.display = 'block';
                msgEl.textContent = `Nenhum homicídio registrado em ${new Date().getFullYear()}.`;
            } else {
                diasContainer.style.display = 'block';
                ultimoEl.style.display = 'block';
                msgEl.style.display = 'none';

                diasEl.textContent = data.dias;
                diasLabelEl.textContent = data.dias === 1 ? 'dia sem homicídio' : 'dias sem homicídio';
                ultimoEl.textContent = `Último registro: ${data.ultimoHomicidio}`;

                diasContainer.classList.remove('status-green', 'status-yellow', 'status-red');
                if (data.dias > 30) {
                    diasContainer.classList.add('status-green');
                } else if (data.dias >= 10) {
                    diasContainer.classList.add('status-yellow');
                } else {
                    diasContainer.classList.add('status-red');
                }
            }
        }
        // --- Fim das Novas Funções ---

        function renderChart(canvasId, type, chartData, options = {}) {
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, { type, data: chartData, options });
        }

        function getCounts(data, key) {
            return data.reduce((acc, item) => {
                const value = item[key] || 'Não Informado';
                acc[value] = (acc[value] || 0) + 1;
                return acc;
            }, {});
        }
        
        const chartColors = ['#3498db', '#e74c3c', '#9b59b6', '#f1c40f', '#2ecc71', '#1abc9c', '#e67e22'];

        function renderTimeChart(canvasId, data) {
            const monthlyCounts = Array(12).fill(0);
            data.forEach(d => { if (d['Mês'] != null) monthlyCounts[d['Mês']]++; });
            const labels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            renderChart(canvasId, 'bar', {
                labels,
                datasets: [{ label: 'Homicídios', data: monthlyCounts, backgroundColor: '#3498db' }]
            });
        }
        
        function renderRankingChart(canvasId, data, key) {
             const sorted = Object.entries(getCounts(data, key)).sort(([,a],[,b]) => b-a).slice(0, 10);
             renderChart(canvasId, 'bar', {
                 labels: sorted.map(item => item[0]),
                 datasets: [{ label: 'Ocorrências', data: sorted.map(item => item[1]), backgroundColor: '#9b59b6' }]
             }, { indexAxis: 'y' });
        }

        function renderDonutChart(canvasId, data, key) {
            const counts = getCounts(data, key);
            renderChart(canvasId, 'doughnut', {
                labels: Object.keys(counts),
                datasets: [{ data: Object.values(counts), backgroundColor: chartColors }]
            });
        }
        
        function renderPieChart(canvasId, data, key, isResolution = false) {
             const counts = getCounts(data, key);
             let labels = Object.keys(counts);
             let colors = chartColors;
             if (isResolution) {
                 labels = labels.map(l => l === 'Sim' ? 'Resolvido' : 'Pendente');
                 colors = labels.map(l => l === 'Resolvido' ? '#2ecc71' : '#e74c3c');
             }
             renderChart(canvasId, 'pie', {
                labels,
                datasets: [{ data: Object.values(counts), backgroundColor: colors }]
             });
        }
        
        function renderBarChart(canvasId, data, key, isHorizontal = true) {
            const sorted = Object.entries(getCounts(data, key)).sort(([,a],[,b]) => b-a);
            renderChart(canvasId, 'bar', {
                labels: sorted.map(item => item[0]),
                datasets: [{ label: 'Contagem', data: sorted.map(item => item[1]), backgroundColor: '#e67e22' }]
            }, { indexAxis: isHorizontal ? 'y' : 'x' });
        }
        
        function renderStackedBarChart(canvasId, data, stackKey, groupKey) {
            const groupedData = data.reduce((acc, curr) => {
                const stack = curr[stackKey] || 'Não Informado';
                const group = curr[groupKey] || 'Não Informado';
                if (!acc[stack]) acc[stack] = {};
                acc[stack][group] = (acc[stack][group] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(groupedData);
            const groups = [...new Set(data.map(item => item[groupKey] || 'Não Informado'))];
            const datasets = groups.map((group, i) => ({
                label: group,
                data: labels.map(label => groupedData[label][group] || 0),
                backgroundColor: chartColors[i % chartColors.length]
            }));

            renderChart(canvasId, 'bar', { labels, datasets }, {
                indexAxis: 'y',
                scales: { x: { stacked: true }, y: { stacked: true } }
            });
        }
        
        function renderResolutionComparisonChart(canvasId, data, key) {
            const unitData = data.reduce((acc, curr) => {
                const unit = curr[key] || 'Não Informada';
                if (!acc[unit]) acc[unit] = { resolved: 0, pending: 0 };
                curr.ResoluçãoNormalizada === 'Sim' ? acc[unit].resolved++ : acc[unit].pending++;
                return acc;
            }, {});
            
            const labels = Object.keys(unitData);
            renderChart(canvasId, 'bar', {
                labels,
                datasets: [
                    { label: 'Resolvido', data: labels.map(l => unitData[l].resolved), backgroundColor: '#2ecc71' },
                    { label: 'Pendente', data: labels.map(l => unitData[l].pending), backgroundColor: '#e74c3c' }
                ]
            }, { scales: { x: { stacked: true }, y: { stacked: true } } });
        }

        function exportData(format) {
            const dataToExport = getFilteredData().map(row => {
                const newRow = {...row};
                if(newRow['Data do fato'] instanceof Date){
                    newRow['Data do fato'] = newRow['Data do fato'].toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                }
                return newRow;
            });

            if (format === 'csv') {
                const csv = Papa.unparse(dataToExport, { header: true });
                downloadFile(csv, 'homicidios_data.csv', 'text/csv;charset=utf-8;');
            } else if (format === 'json') {
                const json = JSON.stringify(dataToExport, null, 2);
                downloadFile(json, 'homicidios_data.json', 'application/json');
            }
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }

        function logPerformance(operation, startTime) {
            const endTime = performance.now();
            console.log(`${operation} took ${Math.round(endTime - startTime)} ms`);
        }

        function validateData(data) {
            return data.filter(row => row && row['Município'] && row['Data do fato']);
        }
    </script>
</body>
</html>

