<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard HomicÃ­dios 3Âª RISP - 2025</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f8f9fa;
    color: #323130;
    margin: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.dashboard-container {
    display: flex;
    width: 100%;
}

/* SIDEBAR */
.sidebar {
    width: 250px;
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 20px 0;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    flex-shrink: 0;
    overflow-y: auto;
}
.sidebar h2 {
    text-align: center;
    margin-bottom: 20px;
    border-bottom: 1px solid #4a627a;
}
.sidebar ul {
    list-style: none;
    padding: 0;
}
.sidebar ul li a {
    display: block;
    padding: 12px 20px;
    color: #ecf0f1;
    text-decoration: none;
    transition: background 0.3s;
}
.sidebar ul li a:hover,
.sidebar ul li a.active {
    background: #34495e;
    border-left: 3px solid #3498db;
}

/* CONTEÃšDO PRINCIPAL */
.main-content {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    position: relative;
}

.header {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    text-align: center;
}

.kpi-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
}

/* CARD DESTAQUE */
.kpi-card-destaque {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    border-radius: 10px;
    text-align: center;
    padding: 30px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.kpi-card-destaque .value {
    font-size: 3.5rem;
    font-weight: 800;
}
.kpi-card-destaque .label {
    font-size: 1.2rem;
    font-weight: 600;
    margin-top: 10px;
}
.kpi-card-destaque .sublabel {
    font-size: 0.9rem;
    font-style: italic;
}

/* SELECTOR DE CIDADE */
#cidade-select-container {
    margin: 10px 0 20px 0;
    text-align: center;
}
#select-cidade-risp {
    padding: 10px 15px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 300px;
    max-width: 90%;
}

/* CARD LATERAL */
#card-lateral {
    position: fixed;
    right: 20px;
    top: 100px;
    width: 260px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    padding: 20px;
    display: none;
    z-index: 10;
    transition: transform 0.4s ease, opacity 0.4s ease;
}
#card-lateral.show {
    display: block;
    opacity: 1;
}
#card-lateral h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #2c3e50;
}
#card-lateral .dias {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 10px 0;
}
#card-lateral .ultima-data {
    font-size: 0.9rem;
    color: #7f8c8d;
}
#card-lateral.status-green { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
#card-lateral.status-yellow { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #2c3e50; }
#card-lateral.status-red { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }

/* RESPONSIVIDADE */
@media (max-width: 768px) {
    body { flex-direction: column; overflow-y: auto; height: auto; }
    .sidebar { width: 100%; position: relative; }
    #card-lateral {
        position: relative;
        width: 100%;
        top: 0;
        right: 0;
        margin-top: 15px;
    }
}
</style>
</head>

<body>
<div class="dashboard-container">
    <nav class="sidebar">
        <h2>HomicÃ­dios 3Âª RISP</h2>
        <ul>
            <li><a href="#visao-geral" class="active">ðŸ“Š VisÃ£o Geral</a></li>
            <li><a href="#perfil-ocorrencia">ðŸ“„ Perfil da OcorrÃªncia</a></li>
            <li><a href="#vitimas-autoria">ðŸ‘¥ VÃ­timas e Autoria</a></li>
            <li><a href="#resolucao-situacao">âœ… ResoluÃ§Ã£o e SituaÃ§Ã£o</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <header class="header">
            <h1>3Â° Comando Regional da PolÃ­cia Militar</h1>
            <h2>Centro de Atendimento Policial Militar - COPOM</h2>
            <p>AnÃ¡lise Criminal - Controle de HomicÃ­dios 2025</p>
        </header>

        <div class="kpi-container">
            <div id="kpi-risp-destaque" class="kpi-card-destaque">
                <div id="kpi-dias-risp" class="value">0</div>
                <div class="label">Dias sem HomicÃ­dio na 3Âª RISP</div>
                <div class="sublabel" id="kpi-ultima-data-risp">Ãšltimo registro: --</div>
            </div>
        </div>

        <div id="cidade-select-container">
            <label for="select-cidade-risp">Selecionar Cidade:</label><br>
            <select id="select-cidade-risp">
                <option value="">Selecione uma cidade...</option>
            </select>
        </div>

        <!-- CARD LATERAL -->
        <div id="card-lateral">
            <h3 id="card-cidade-nome">Cidade</h3>
            <div class="dias" id="card-dias">0</div>
            <div class="ultima-data" id="card-ultima-data">Ãšltimo registro: --</div>
        </div>
    </main>
</div>

<script>
const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRaVwtuyh-PxPwjA6yZ5twRF4xamo5UrlEmh5zo4BldYtNZfpJ9u-4xfg7f11uEbA/pub?output=csv';
let fullData = [];
let diasSemHomicidioData = {};

document.addEventListener("DOMContentLoaded", () => {
    Papa.parse(DATA_URL, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            fullData = processData(results.data);
            diasSemHomicidioData = calcularDiasSemHomicidio(fullData);
            populateCidadeSelect();
            updateDiasRISP(fullData);
        },
        error: function(err){ console.error("Erro ao carregar CSV:", err); }
    });
});

function processData(data) {
    return data.map(row => {
        const dataStr = row["Data do Fato"] || row["Data"] || "";
        const municipio = row["MunicÃ­pio"] || row["Cidade"] || "";
        if (!dataStr || !municipio) return null;
        const [dia, mes, ano] = dataStr.split("/");
        return { municipio, data: new Date(`${ano}-${mes}-${dia}`) };
    }).filter(Boolean);
}

function calcularDiasSemHomicidio(dados) {
    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const resultado = {};
    const cidades = [...new Set(dados.map(i => i.municipio))];
    cidades.forEach(cidade => {
        const homicidios = dados.filter(i => i.municipio === cidade).map(i => i.data).sort((a,b)=>b-a);
        if (!homicidios.length) { resultado[cidade] = null; return; }
        const ultimo = homicidios[0]; ultimo.setHours(0,0,0,0);
        const diff = Math.floor((hoje - ultimo)/(1000*60*60*24));
        resultado[cidade] = { dias: diff, ultimoHomicidio: ultimo.toLocaleDateString('pt-BR') };
    });
    return resultado;
}

function populateCidadeSelect() {
    const sel = document.getElementById("select-cidade-risp");
    Object.keys(diasSemHomicidioData).sort().forEach(cidade => {
        const opt = document.createElement("option");
        opt.value = cidade; opt.textContent = cidade;
        sel.appendChild(opt);
    });
    sel.addEventListener("change", e => showCardCidade(e.target.value));
}

function showCardCidade(cidade) {
    const card = document.getElementById("card-lateral");
    if (!cidade) { card.style.display = "none"; return; }
    const data = diasSemHomicidioData[cidade];
    if (!data) { card.style.display = "none"; return; }

    card.querySelector("#card-cidade-nome").textContent = cidade;
    card.querySelector("#card-dias").textContent = data.dias;
    card.querySelector("#card-ultima-data").textContent = `Ãšltimo registro: ${data.ultimoHomicidio}`;

    card.classList.remove("status-green","status-yellow","status-red");
    if (data.dias > 30) card.classList.add("status-green");
    else if (data.dias >= 10) card.classList.add("status-yellow");
    else card.classList.add("status-red");

    card.style.display = "block";
}

function updateDiasRISP(dados) {
    if (!dados.length) return;
    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const datas = dados.map(i => i.data).sort((a,b)=>b-a);
    const ultima = datas[0]; ultima.setHours(0,0,0,0);
    const diff = Math.floor((hoje - ultima)/(1000*60*60*24));
    document.getElementById("kpi-dias-risp").textContent = diff;
    document.getElementById("kpi-ultima-data-risp").textContent = `Ãšltimo registro: ${ultima.toLocaleDateString('pt-BR')}`;
}
</script>
</body>
</html>
